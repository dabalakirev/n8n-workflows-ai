name: ðŸŽ« Issue Automation

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed]

# Fix for 403 "Resource not accessible by integration" error
permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  auto-label:
    name: ðŸ·ï¸ Auto-assign Labels
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # ðŸ” DEBUGGING: Log automation trigger context
    - name: ðŸ› Debug Issue Automation Context
      run: |
        echo "## ðŸŽ« ISSUE AUTOMATION EXECUTION" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Action | ${{ github.event.action }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Issue Number | #${{ github.event.issue.number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Author | ${{ github.event.issue.user.login }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Title Length | ${{ length(github.event.issue.title) }} chars |" >> $GITHUB_STEP_SUMMARY
        echo "| Has Body | ${{ github.event.issue.body != '' }} |" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ·ï¸ Auto-label based on title
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const title = context.payload.issue.title.toLowerCase();
          const body = context.payload.issue.body?.toLowerCase() || '';
          const labels = [];
          
          // ðŸ” DEBUGGING: Log input data
          console.log('Processing issue:', context.payload.issue.number);
          console.log('Title:', title);
          console.log('Body length:', body.length);
          
          // Priority labels based on content
          if (title.includes('critical') || body.includes('critical') || body.includes('ðŸ”´ critical')) {
            labels.push('ðŸ”´ critical');
          } else if (title.includes('high') || body.includes('high priority') || body.includes('ðŸŸ¡ high')) {
            labels.push('ðŸŸ¡ high');
          } else if (title.includes('low') || body.includes('low priority') || body.includes('âšª low')) {
            labels.push('âšª low');
          } else {
            labels.push('ðŸŸ¢ medium');
          }
          
          // Component labels
          if (title.includes('deepseek') || body.includes('deepseek')) {
            labels.push('ðŸ¤– ai-deepseek');
          }
          if (title.includes('fmp') || title.includes('router') || body.includes('fmp')) {
            labels.push('ðŸ”— fmp-router');
          }
          if (title.includes('orchestrator') || body.includes('test orchestrator')) {
            labels.push('ðŸ§ª test-orchestrator');
          }
          
          // Environment labels
          if (body.includes('[x] dev') || body.includes('dev Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ') || title.includes('dev')) {
            labels.push('ðŸ”„ dev');
          }
          if (body.includes('[x] prod') || body.includes('prod Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ') || title.includes('prod')) {
            labels.push('ðŸš€ prod');
          }
          
          // ðŸ” DEBUGGING: Log label assignment decision
          console.log('Auto-assigned labels:', labels);
          console.log('Label count:', labels.length);
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
            console.log('âœ… Labels successfully applied');
          } else {
            console.log('âš ï¸ No labels matched for auto-assignment');
          }

  template-validation:
    name: âœ… Validate Issue Template
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    
    steps:
    - name: ðŸ” Check Template Compliance
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const title = context.payload.issue.title;
          const body = context.payload.issue.body || '';
          
          let warnings = [];
          let suggestions = [];
          
          // ðŸ” DEBUGGING: Log validation input
          console.log('Validating issue template compliance for:', title);
          console.log('Body contains sections:', body.split('##').length - 1);
          
          // Check title format
          const titleFormats = ['[BUG]', '[FEATURE]', '[ENHANCEMENT]', '[DOCS]', '[TEST]'];
          const hasValidFormat = titleFormats.some(format => title.includes(format));
          
          if (!hasValidFormat) {
            warnings.push('Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ: ' + titleFormats.join(', '));
          }
          
          // Check for required sections in bug reports
          if (title.includes('[BUG]')) {
            if (!body.includes('## ðŸ”„ Ð—Ð°Ñ‚Ñ€Ð¾Ð½ÑƒÑ‚Ñ‹Ð¹ workflow')) {
              warnings.push('Bug report Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÑÐµÐºÑ†Ð¸ÑŽ "Ð—Ð°Ñ‚Ñ€Ð¾Ð½ÑƒÑ‚Ñ‹Ð¹ workflow"');
            }
            if (!body.includes('## ðŸ“ Ð¨Ð°Ð³Ð¸ Ð´Ð»Ñ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ñ')) {
              warnings.push('Bug report Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÑÐµÐºÑ†Ð¸ÑŽ "Ð¨Ð°Ð³Ð¸ Ð´Ð»Ñ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ñ"');
            }
          }
          
          // Check for required sections in feature requests
          if (title.includes('[FEATURE]')) {
            if (!body.includes('## ðŸ’¡ ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚')) {
              warnings.push('Feature request Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÑÐµÐºÑ†Ð¸ÑŽ "ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚"');
            }
            if (!body.includes('## ðŸ§ª ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ¸')) {
              warnings.push('Feature request Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÑÐµÐºÑ†Ð¸ÑŽ "ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ð¿Ñ€Ð¸ÐµÐ¼ÐºÐ¸"');
            }
          }
          
          // ðŸ” DEBUGGING: Log validation results
          console.log('Validation warnings:', warnings.length);
          console.log('Template compliance:', warnings.length === 0 ? 'PASS' : 'FAIL');
          
          // Create comment if there are issues
          if (warnings.length > 0) {
            const comment = `## ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ
            
          âš ï¸ **ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Issue:**
          
          ${warnings.map(w => `- ${w}`).join('\n')}
          
          ðŸ“– **Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:**
          - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Issues
          - Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ†Ð¸Ð¸
          - Ð¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ [GitHub Issues Protocol](../blob/main/docs/github-issues-protocol.md)
          
          *Ð­Ñ‚Ð¾Ñ‚ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸*`;
          
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('âœ… Template compliance comment posted');
          } else {
            console.log('âœ… Issue template compliance verified - no warnings');
          }

  milestone-assignment:
    name: ðŸ“… Auto-assign Milestones
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    
    steps:
    - name: ðŸŽ¯ Assign to Roadmap Milestone
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const title = context.payload.issue.title.toLowerCase();
          const body = context.payload.issue.body?.toLowerCase() || '';
          const labels = context.payload.issue.labels.map(l => l.name);
          
          let milestone = null;
          
          // ðŸ” DEBUGGING: Log milestone assignment logic
          console.log('Analyzing issue for milestone assignment');
          console.log('Title keywords:', title.split(' ').slice(0, 5));
          console.log('Labels:', labels);
          
          // v1.1 - Testing Framework (highest priority)
          if (title.includes('test') || title.includes('orchestrator') || 
              body.includes('test orchestrator') || body.includes('execute workflow trigger') ||
              labels.some(l => l.includes('testing'))) {
            milestone = 'v1.1 - Testing Framework';
          }
          // v1.2 - Infrastructure & Automation  
          else if (title.includes('github action') || title.includes('automation') ||
                   title.includes('ci/cd') || title.includes('pipeline') ||
                   body.includes('github actions')) {
            milestone = 'v1.2 - Infrastructure & Automation';
          }
          // v1.3 - Advanced Features
          else if (title.includes('advanced') || title.includes('optimization') ||
                   title.includes('monitoring') || body.includes('enterprise')) {
            milestone = 'v1.3 - Advanced Features';
          }
          // Default to current milestone for high priority items
          else if (labels.some(l => l.includes('ðŸ”´ critical') || l.includes('ðŸŸ¡ high'))) {
            milestone = 'v1.1 - Testing Framework';
          }
          
          // ðŸ” DEBUGGING: Log milestone decision
          console.log('Assigned milestone:', milestone || 'None');
          
          if (milestone) {
            console.log(`Auto-assigning to milestone: ${milestone}`);
            
            // Note: This requires milestones to be created manually in GitHub first
            // The actual API call would need milestone numbers, not names
            const comment = `ðŸŽ¯ **Auto-assignment**: Ð­Ñ‚Ð¾Ñ‚ Issue Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÑÑ Ðº milestone **${milestone}**
            
          Ð¡Ð¾Ð³Ð»Ð°ÑÐ½Ð¾ [Project Roadmap](../blob/main/docs/roadmap.md), ÑÑ‚Ð° Ð·Ð°Ð´Ð°Ñ‡Ð° Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð´Ð»Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð³Ð¾ milestone.
          
          *Milestone Ð±ÑƒÐ´ÐµÑ‚ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð² GitHub Projects.*`;
          
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('âœ… Milestone assignment comment posted');
          } else {
            console.log('â„¹ï¸ No milestone criteria matched - manual assignment needed');
          }

  close-automation:
    name: ðŸ”„ Handle Issue Closure
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
    # ðŸ“ SKIP REASON: This job only runs when issues are closed
    # Will be skipped for all other issue events (opened, edited, reopened)
    - name: ðŸ“Š Update Project Metrics
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const issue = context.payload.issue;
          
          // ðŸ” DEBUGGING: Log closure event details
          console.log('Processing issue closure:', issue.number);
          console.log('Issue state:', issue.state);
          console.log('Closed by:', issue.closed_by?.login || 'Unknown');
          console.log('Total comments:', issue.comments);
          
          // Create closure summary comment
          const comment = `## âœ… Issue Closed
          
          **Closed at**: ${new Date().toISOString()}
          **Total comments**: ${issue.comments}
          **Labels**: ${issue.labels.map(l => l.name).join(', ') || 'None'}
          
          ðŸ“Š **Impact**: Ð­Ñ‚Ð¾Ñ‚ Issue Ð±Ñ‹Ð» Ñ‡Ð°ÑÑ‚ÑŒÑŽ roadmap Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° n8n workflows.
          
          ---
          *ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾ Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Issue*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          console.log(`âœ… Issue #${issue.number} closure processed: ${issue.title}`);

  pr-link-issues:
    name: ðŸ”— Link PRs to Issues
    runs-on: ubuntu-latest
    if: github.event.pull_request && github.event.action == 'opened'
    
    steps:
    # ðŸ“ SKIP REASON: This job only runs when pull requests are opened  
    # Will be skipped for issue events and other PR events (closed, edited, etc.)
    - name: ðŸ” Find Related Issues
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body?.toLowerCase() || '';
          const title = pr.title.toLowerCase();
          
          // ðŸ” DEBUGGING: Log PR analysis
          console.log('Analyzing PR for issue links:', pr.number);
          console.log('PR title:', title);
          console.log('Body length:', body.length);
          
          // Look for issue references in PR
          const issueRefs = [];
          const patterns = [
            /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#(\d+)/gi,
            /#(\d+)/g
          ];
          
          patterns.forEach(pattern => {
            let match;
            while ((match = pattern.exec(body + ' ' + title)) !== null) {
              const issueNum = parseInt(match[1]);
              if (!issueRefs.includes(issueNum)) {
                issueRefs.push(issueNum);
              }
            }
          });
          
          // ðŸ” DEBUGGING: Log issue reference detection
          console.log('Found issue references:', issueRefs);
          console.log('Issue link count:', issueRefs.length);
          
          if (issueRefs.length > 0) {
            const comment = `ðŸ”— **Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Issues**: ${issueRefs.map(n => `#${n}`).join(', ')}
            
          Ð­Ñ‚Ð¾Ñ‚ Pull Request ÑÐ²ÑÐ·Ð°Ð½ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Issues. ÐŸÐ¾ÑÐ»Ðµ merge ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Issues Ð±ÑƒÐ´ÑƒÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹ ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° (closes, fixes, resolves).`;
          
            await github.rest.issues.createComment({
              issue_number: pr.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('âœ… Issue link comment posted');
          } else {
            console.log('â„¹ï¸ No issue references found in PR');
          }

  # ðŸ” DEBUGGING: Summary job that always runs to show workflow execution
  automation-summary:
    name: ðŸ“‹ Automation Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [auto-label, template-validation, milestone-assignment, close-automation, pr-link-issues]
    
    steps:
    - name: ðŸ“Š Generate Execution Summary
      run: |
        echo "## ðŸŽ« ISSUE AUTOMATION SUMMARY" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status | Reason |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|---------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Auto-label | ${{ needs.auto-label.result }} | ${{ needs.auto-label.result == 'skipped' && 'Not an opened issue' || 'Completed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Template Validation | ${{ needs.template-validation.result }} | ${{ needs.template-validation.result == 'skipped' && 'Not an opened issue' || 'Completed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Milestone Assignment | ${{ needs.milestone-assignment.result }} | ${{ needs.milestone-assignment.result == 'skipped' && 'Not an opened issue' || 'Completed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Close Automation | ${{ needs.close-automation.result }} | ${{ needs.close-automation.result == 'skipped' && 'Issue not closed' || 'Completed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| PR Link Issues | ${{ needs.pr-link-issues.result }} | ${{ needs.pr-link-issues.result == 'skipped' && 'Not a PR opened event' || 'Completed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Event**: ${{ github.event_name }} (${{ github.event.action }})" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event.issue.number || github.event.pull_request.number || 'N/A' }}" >> $GITHUB_STEP_SUMMARY