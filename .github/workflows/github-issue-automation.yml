name: ðŸŽ« GitHub Issue Automation

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed]

# Fix for 403 "Resource not accessible by integration" error
permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  auto-label:
    name: ðŸ·ï¸ Auto-assign Labels
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ› Debug Issue Automation Context
      run: |
        echo "## ðŸŽ« ISSUE AUTOMATION EXECUTION" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Action | ${{ github.event.action }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Issue Number | #${{ github.event.issue.number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Author | ${{ github.event.issue.user.login }} |" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ·ï¸ Auto-label based on title
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const title = context.payload.issue.title.toLowerCase();
          const body = context.payload.issue.body?.toLowerCase() || '';
          const labels = [];
          
          console.log('Processing issue:', context.payload.issue.number);
          
          // Priority labels based on content
          if (title.includes('critical') || body.includes('critical')) {
            labels.push('ðŸ”´ critical');
          } else if (title.includes('high') || body.includes('high priority')) {
            labels.push('ðŸŸ¡ high');
          } else if (title.includes('low') || body.includes('low priority')) {
            labels.push('âšª low');
          } else {
            labels.push('ðŸŸ¢ medium');
          }
          
          // Component labels
          if (title.includes('deepseek') || body.includes('deepseek')) {
            labels.push('ðŸ¤– ai-deepseek');
          }
          if (title.includes('fmp') || title.includes('router')) {
            labels.push('ðŸ”— fmp-router');
          }
          if (title.includes('orchestrator')) {
            labels.push('ðŸ§ª test-orchestrator');
          }
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
          }

  template-validation:
    name: âœ… Validate Issue Template
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    
    steps:
    - name: ðŸ” Check Template Compliance
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const title = context.payload.issue.title;
          const body = context.payload.issue.body || '';
          let warnings = [];
          
          const titleFormats = ['[BUG]', '[FEATURE]', '[ENHANCEMENT]', '[DOCS]', '[TEST]'];
          const hasValidFormat = titleFormats.some(format => title.includes(format));
          
          if (!hasValidFormat) {
            warnings.push('Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ: ' + titleFormats.join(', '));
          }
          
          if (warnings.length > 0) {
            const comment = `## ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ
            
          âš ï¸ **ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Issue:**
          
          ${warnings.map(w => `- ${w}`).join('\n')}
          
          *Ð­Ñ‚Ð¾Ñ‚ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸*`;
          
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  automation-summary:
    name: ðŸ“‹ Automation Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [auto-label, template-validation]
    
    steps:
    - name: ðŸ“Š Generate Execution Summary
      run: |
        echo "## ðŸŽ« CLEAN ISSUE AUTOMATION SUMMARY" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Auto-label | ${{ needs.auto-label.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Template Validation | ${{ needs.template-validation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Event**: ${{ github.event_name }} (${{ github.event.action }})" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: CLEAN WORKFLOW - NO PUSH TRIGGERS" >> $GITHUB_STEP_SUMMARY